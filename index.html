<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Jarvis</title>
<link rel="shortcut icon" href="assets/friday.png" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" crossorigin="anonymous"/>

<style>
  :root{
    --sidebar-w: 260px;
    --pink:#ff4081;
    --cy:#00e5ff;
    --bg:#0b0b0c;
    --panel:#141417;
    --panel-2:#1b1b20;
    --text:#e8eef6;
    --muted:#a8b3bd;
    --border:#262730;
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',sans-serif;background:#000;color:var(--text);height:100vh;display:flex;overflow:hidden}

  /* ===== Sidebar (ChatGPT-style) ===== */
  .sidebar{
    width:var(--sidebar-w);
    background:var(--panel);
    border-right:1px solid var(--border);
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .side-top{display:flex;flex-direction:column;gap:6px}
  .side-item{
    position:relative;
    display:flex;align-items:center;gap:10px;
    padding:10px 10px;border-radius:10px;cursor:pointer;
    color:var(--text);
  }
  .side-item:hover{background:var(--panel-2)}
  .side-item i{width:20px;text-align:center;color:#cbd5e1}
  .divider{height:1px;background:var(--border);margin:4px 0 6px}

  .section-title{
    font-size:.72rem;text-transform:uppercase;letter-spacing:.04em;
    color:var(--muted);padding:0 6px;margin-top:2px;
  }

  .chat-history{flex:1;overflow-y:auto;padding-right:4px}
  .chat-item{
    position:relative;
    display:flex;align-items:center;justify-content:space-between;
    gap:10px;padding:10px;border-radius:10px;cursor:pointer;
  }
  .chat-item:hover{background:var(--panel-2)}
  .chat-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:170px}
  .chat-stamp{font-size:.72rem;color:var(--muted);margin-top:4px}
  .chat-right{display:flex;align-items:center;gap:8px}
  .dot-btn{
    width:26px;height:26px;border-radius:8px;display:grid;place-items:center;
    color:#cbd5e1;
  }
  .chat-item:hover .dot-btn{background:#202028}
  .dot-btn i{font-size:14px}

  .menu{
    position:absolute;right:8px;top:38px;min-width:160px;z-index:9999;
    background:#121217;border:1px solid var(--border);border-radius:12px;overflow:hidden;
    display:none;
  }
  .menu.open{display:block}
  .menu-btn{
    display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;
  }
  .menu-btn i{width:18px;text-align:center;color:#cbd5e1}
  .menu-btn:hover{background:#1b1c23}

  /* ===== Main ===== */
  .main{flex:1;position:relative;display:flex;flex-direction:column}
  video.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2;filter:brightness(.55)}
  .header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .header .brand{display:flex;align-items:center;gap:10px}
  .brand p{font-size:1.35rem;font-weight:700;margin:0}
  .insta{background:var(--pink);border:none;padding:8px 14px;border-radius:8px;color:#fff;text-decoration:none}

  .toggle{display:none;background:none;color:#fff;border:none;font-size:1.4rem}

  .chat-box{flex:1;overflow-y:auto;padding:18px 22px;display:flex;flex-direction:column;gap:10px}
  .bubble{max-width:80%;padding:10px 12px;border-radius:12px;line-height:1.5;backdrop-filter: blur(2px)}
  .user{align-self:flex-end;background:rgba(0,229,255,.18);border:1px solid rgba(0,229,255,.35)}
  .bot{align-self:flex-start;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.25)}
  .meta{display:block;font-size:.72rem;color:var(--muted);margin-top:6px}

  .typing{align-self:flex-start;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.25);padding:10px 12px;border-radius:12px}
  .dots{display:inline-block}
  .dots span{display:inline-block;width:6px;height:6px;border-radius:50%;background:#ddd;margin-right:4px;animation:blink 1s infinite}
  .dots span:nth-child(2){animation-delay:.2s}
  .dots span:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,80%,100%{opacity:.1}40%{opacity:1}}

  .input-area{display:flex;gap:10px;padding:10px;background:rgba(0,0,0,.6);border-top:1px solid var(--border)}
  .input-area input{flex:1;padding:10px;border:none;border-radius:8px;background:#1f1f1f;color:#fff}
  .send{background:var(--cy);border:none;padding:10px 14px;border-radius:8px;color:#042027;cursor:pointer;font-weight:700}
  .mic{background:var(--pink);border:none;width:44px;height:44px;border-radius:50%;display:grid;place-items:center;color:#fff;cursor:pointer}
  .mic.listening{box-shadow:0 0 0 0 rgba(0,229,255,.7);animation:pulse 1.2s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,229,255,.6)}70%{box-shadow:0 0 0 16px rgba(0,229,255,0)}100%{box-shadow:0 0 0 0 rgba(0,229,255,0)}}

  /* ===== Share Modal ===== */
  .share-modal{display:none;position:fixed;z-index:99999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6)}
  .share-wrap{background:#141419;border:1px solid var(--border);color:#fff;width:min(460px,92vw);margin:10vh auto;padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.6)}
  .share-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .share-head h3{margin:0;font-size:1rem}
  .share-close{background:none;border:none;color:#cbd5e1;font-size:20px;cursor:pointer}
  .share-warning{font-size:.84rem;color:#ffd27a;background:#211905;border:1px solid #3a2d0c;padding:8px;border-radius:8px;margin:8px 0 12px}
  #shareLink{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:#101015;color:#fff}
  .share-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:#1b1b21;color:#fff;cursor:pointer}
  .btn.primary{background:var(--pink);border:none}

  /* ===== SEARCH MODAL (Glass, simple, professional) ===== */
  .search-modal{display:none;position:fixed;inset:0;z-index:99998;background:rgba(0,0,0,.55);backdrop-filter:blur(6px)}
  .search-wrap{width:min(720px,94vw);margin:10vh auto;background:rgba(20,20,25,.6);border:1px solid var(--border);border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,.6);overflow:hidden}
  .search-head{display:flex;align-items:center;gap:10px;padding:12px 12px;border-bottom:1px solid var(--border)}
  .search-head i{opacity:.8}
  #searchInput{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:1rem}
  .kbd{font-size:.78rem;border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:var(--muted)}
  .search-body{max-height:52vh;overflow:auto}
  .result{display:flex;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer}
  .result:hover{background:rgba(255,255,255,.04)}
  .r-left{display:flex;flex-direction:column;gap:4px;flex:1}
  .r-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .r-snippet{font-size:.88rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .r-time{font-size:.74rem;color:var(--muted)}

  /* ===== Tiny tooltip for Search item ===== */
  .side-item[data-tip]{position:relative}
  .side-item[data-tip]:hover::after{
    content:attr(data-tip);
    position:absolute;left:100%;top:50%;transform:translate(8px,-50%);
    white-space:nowrap;font-size:.72rem;color:var(--muted);
    background:#101015;border:1px solid var(--border);padding:4px 6px;border-radius:6px;
    pointer-events:none;
  }

  /* ===== Mobile ===== */
  @media (max-width:768px){
    .toggle{display:block}
    .sidebar{position:absolute;height:100%;z-index:10;transform:translateX(-100%);transition:transform .28s ease}
    .sidebar.open{transform:translateX(0)}
  }
  
</style>
</head>
<body>

<!-- ===== Sidebar ===== -->
<aside id="sidebar" class="sidebar">
  <!-- Top shortcuts -->
  <div class="side-top">
    <img src="/assets/friday.png" alt="" width="90px">
    <div id="btnNew" class="side-item" data-tip="Ctrl + Shift + P"><i class="fa-regular fa-square-plus"></i><span>New chat</span></div>
    <div id="btnSearch" class="side-item" data-tip="Ctrl + K"><i class="fa-solid fa-magnifying-glass"></i><span>Search chats</span></div>
    <div id="btnLibrary" class="side-item"><i class="fa-regular fa-folder-open"></i><span>Library</span></div>
  </div>

  <div class="divider"></div>

  <!-- Chats -->
  <div class="section-title">Chats</div>
  <div id="history" class="chat-history"></div>
</aside>

<!-- ===== Main ===== -->
<main class="main">
  <video class="bg" src="images/friday.mp4" autoplay loop muted></video>

  <div class="header">
    <button id="toggle" class="toggle"><i class="fa fa-bars"></i></button>
    <div class="brand">
      <img src="" alt="" style="width:0;height:0" />
      <img src="da-removebg-preview.png" alt="" width="150px" >
    </div>
    <!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="actions">
<!-- Share Button -->
<button class="share-btn" id="openShare">
  <i class="fa fa-share"></i>
</button>

<!-- Share Modal (Bottom on mobile, Center on desktop) -->
<div id="shareSheet" class="share-sheet">
  <div class="sheet-content">
    <div class="sheet-header">
      <h4>Share chat</h4>
      <button class="close-sheet" id="closeSheet">&times;</button>
    </div>
    <ul class="sheet-options">
      <li id="copyLink"><i class="fa fa-link"></i> Copy Link</li>
      <li><i class="fa fa-facebook"></i> Share to Facebook</li>
      <li><i class="fa fa-twitter"></i> Share to Twitter</li>
      <li><i class="fa fa-envelope"></i> Email</li>
    </ul>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast">âœ… Your link is copied!</div>

  <div class="dropdown">
    <button class="menu-btn"><i class="fa fa-ellipsis-h"></i></button>
    <ul class="dropdown-menu">
      <li id="archiveChat"><i class="fa fa-archive"></i> Archive</li>
      <li id="reportChat"><i class="fa fa-flag"></i> Report</li>
      <li id="deleteChat"><i class="fa fa-trash"></i> Delete</li>
    </ul>
  </div>
</div>

<div id="reportModal" class="modal">
  <div class="modal-content">
    <h3>Report Chat</h3>
    <textarea id="reportReason" placeholder="Describe the problem..." required></textarea>
    <div class="modal-footer">
      <button id="closeModal">Cancel</button>
      <button id="sendReport">Send Report</button>
    </div>
  </div>
</div>


<!-- Success Message -->
<div id="successMsg" class="success-msg">
  âœ… Your message has been sent. We will work on the mistake so it wonâ€™t happen again. Thank you.
</div>

<style>
/* Overlay background */
.share-sheet {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: flex-end;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 999;
}
.share-sheet.show {
  opacity: 1;
  pointer-events: auto;
}

/* Sheet box */
.sheet-content {
  background: #000;
  border-radius: 16px 16px 0 0;
  width: 100%;
  max-width: 480px;
  padding: 16px;
  transform: translateY(100%);
  transition: transform 0.3s ease;
}
.share-sheet.show .sheet-content {
  transform: translateY(0);
}

/* On desktop center it */
@media (min-width: 768px) {
  .share-sheet {
    align-items: center; /* center vertically */
  }
  .sheet-content {
    border-radius: 12px;
    transform: scale(0.8);
    transition: transform 0.3s ease;
  }
  .share-sheet.show .sheet-content {
    transform: scale(1);
  }
}

/* Header */
.sheet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.sheet-header h4 { margin: 0; font-size: 18px; }
.close-sheet {
  border: none;
  background: none;
  font-size: 22px;
  cursor: pointer;
}

/* Options */
.sheet-options {
  list-style: none;
  padding: 0;
  margin: 0;
}
.sheet-options li {
  padding: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 15px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background 0.2s;
}
.sheet-options li:hover { background: #333; }

/* Toast notification */
.toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 14px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease, transform 0.4s ease;
  z-index: 2000;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}



/* Actions & Buttons */
.actions{display:flex;align-items:center;gap:8px;margin-bottom:30px}
.share-btn,.menu-btn{display:inline-flex;align-items:center;gap:6px;background:transparent;border:none;color:#fff;font-size:18px;cursor:pointer;padding:6px 10px;border-radius:6px}
.share-btn:hover,.menu-btn:hover{background:#333; border-radius: 20%;}

/* Dropdown */
.dropdown{position:relative}
.dropdown-menu{display:block;opacity:0;transform:translateY(-10px);pointer-events:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #ddd;border-radius:6px;list-style:none;padding:5px 0;margin:4px 0;min-width:180px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:10;transition:all 0.2s ease}
.dropdown-menu li{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;color:#333}
.dropdown-menu li:hover{background:#f1f1f1}
.dropdown.show .dropdown-menu{opacity:1;transform:translateY(0);pointer-events:auto}

/* Modal */
/* Modal Overlay */
.modal {
  display: none;  /* hidden by default */
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.modal.show {
  opacity: 1;
  pointer-events: auto;
}

/* Modal Content */
.modal-content {
  background: #fff;
  padding: 24px 28px;
  border-radius: 12px;
  max-width: 450px;
  width: 100%;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  text-align: left;
  animation: slideDown 0.3s ease;
}

/* Title */
.modal-content h3 {
  margin: 0 0 12px;
  font-size: 20px;
  color: #333;
  font-weight: 600;
  border-bottom: 1px solid #eee;
  padding-bottom: 8px;
}

/* Textarea */
.modal textarea {
  width: 100%;
  height: 120px;
  margin: 12px 0 16px;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  resize: none;
  font-size: 14px;
  font-family: inherit;
  transition: border 0.2s;
}
.modal textarea:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.15);
}

/* Buttons */
.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.modal button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s ease;
}
#sendReport {
  background: #007bff;
  color: #fff;
}
#sendReport:hover {
  background: #0056b3;
}
#closeModal {
  background: #e0e0e0;
  color: #333;
}
#closeModal:hover {
  background: #ccc;
}

/* Animation */
@keyframes slideDown {
  from { transform: translateY(-20px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}

/* Success Message */
.success-msg{display:none;position:fixed;bottom:20px;right:20px;background:#4caf50;color:#fff;padding:10px 16px;border-radius:6px;box-shadow:0 4px 6px rgba(0,0,0,0.2);z-index:30}
</style>

<script>
// Dropdown toggle
document.querySelectorAll('.menu-btn').forEach(btn=>{
  btn.addEventListener('click', e=>{
    const dropdown = btn.parentElement;
    dropdown.classList.toggle('show');
  });
});
// Close dropdown on outside click
window.addEventListener('click', e=>{
  document.querySelectorAll('.dropdown').forEach(d=>{
    if(!d.contains(e.target)) d.classList.remove('show');
  });
});

// Archive chat
document.getElementById('archiveChat').addEventListener('click', ()=>{
  document.getElementById('chatBox').style.display = 'none';
  alert("Chat has been archived âœ…");
});

// Delete chat
document.getElementById('deleteChat').addEventListener('click', ()=>{
  document.getElementById('chatBox').remove();
  alert("Chat has been deleted ðŸ—‘ï¸");
});

// Report chat modal
const modal = document.getElementById('reportModal');
document.getElementById('reportChat').addEventListener('click', ()=> modal.classList.add("show"));
document.getElementById('closeModal').addEventListener('click', ()=> modal.classList.remove("show"));

// Send report
document.getElementById('sendReport').addEventListener('click', ()=>{
  const reason = document.getElementById('reportReason').value.trim();
  if(reason===""){ alert("âš ï¸ Please describe the problem before sending."); return; }
  
  modal.style.display="none";
  document.getElementById('reportReason').value="";
  
  // Show success message
  const msg = document.getElementById('successMsg');
  msg.style.display="block";
  setTimeout(()=> msg.style.display="none", 4000);
});
const sheet = document.getElementById('shareSheet');
const openBtn = document.getElementById('openShare');
const closeBtn = document.getElementById('closeSheet');
const copyLink = document.getElementById('copyLink');
const toast = document.getElementById('toast');

// Open modal
openBtn.addEventListener('click', ()=> sheet.classList.add("show"));

// Close modal (X button)
closeBtn.addEventListener('click', ()=> sheet.classList.remove("show"));

// Close modal if click outside content
sheet.addEventListener('click', (e)=>{
  if(e.target === sheet) sheet.classList.remove("show");
});

// Copy link + show toast
copyLink.addEventListener('click', ()=>{
  navigator.clipboard.writeText(window.location.href); // copy current URL
  sheet.classList.remove("show"); // close modal after copy

  // Show toast
  toast.classList.add("show");
  setTimeout(()=> toast.classList.remove("show"), 2000);
});

</script>

  </div>

  <section id="chat" class="chat-box"></section>

  <div class="input-area">
  <div class="input-box">
    <!-- Plus Button -->
    <div class="plus-menu">
      <button class="plus-btn"><i class="fa fa-plus"></i></button>
      <div class="dropdown">
        <button><i class="fa fa-image"></i> Create Image</button>
        <button><i class="fa fa-file"></i> Upload File</button>
      </div>
    </div>

    <!-- Text Input -->
    <input id="text" placeholder="Send a message..." />

    <!-- Mic & Send -->
    <button id="mic" class="mic"><i class="fa fa-microphone"></i></button>
    <button id="send" class="send"><i class="fa fa-paper-plane"></i></button>
  </div>
</div>

<style>
  
  .input-area {
  position: sticky;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0,0,0,.85);
  border-top: 1px solid var(--border);
  padding: 12px 16px;
  display: flex;
  justify-content: center;
  z-index: 5;
}

.input-box {
  flex: 1;
  max-width: 750px;
  display: flex;
  align-items: center;
  background: #1e1e20;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 6px 10px;
  gap: 8px;
}

.input-box input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  padding: 10px;
  color: var(--text);
  font-size: 1rem;
}

.input-box button {
  background: transparent;
  border: none;
  color: var(--muted);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 6px;
  border-radius: 8px;
  transition: background 0.2s;
}

.input-box button:hover {
  background: rgba(255,255,255,.08);
}

.input-box .send {
  color: var(--cy);
  font-size: 1.3rem;
}

.input-box .mic {
  color: var(--pink);
}

</style>
  </div>
</main>

<!-- ===== Share Popup ===== -->
<div id="shareModal" class="share-modal">
  <div class="share-wrap">
    <div class="share-head">
      <h3>Share public link to chat</h3>
      <button class="share-close" id="shareClose">&times;</button>
    </div>
    <div class="share-warning">
      This conversation may include personal information. Please check the content before sharing.
    </div>
    <input type="text" id="shareLink" readonly>
    <div class="share-actions">
      <button class="btn" id="shareCopy">Copy</button>
      <button class="btn primary" id="shareCreate">Create link</button>
    </div>
  </div>
</div>

<!-- ===== SEARCH POPUP ===== -->
<div id="searchModal" class="search-modal" aria-hidden="true">
  <div class="search-wrap" role="dialog" aria-modal="true" aria-labelledby="searchTitle">
    <div class="search-head">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input id="searchInput" placeholder="Search your chats..." autocomplete="off" />
      <span class="kbd">Ctrl + K</span>
    </div>
    <div id="searchResults" class="search-body"></div>
  </div>
</div>

<script>
/* =========================
   Config
========================= */
const CHAT_API = 'http://localhost:3000/chat';  // now points to your proxy
const CMD_API  = 'http://localhost:5000/command';  // Your command backend
const SHARE_BASE = 'http://localhost:3000/shared/';// Optional: if you add share endpoint

/* =========================
   DOM refs
========================= */
const $ = s => document.querySelector(s);
const chatBox = $('#chat');
const historyEl = $('#history');
const input = $('#text');
const micBtn = $('#mic');
const sendBtn = $('#send');
const toggleBtn = $('#toggle');
const sidebar = $('#sidebar');

const shareModal = $('#shareModal');
const shareClose = $('#shareClose');
const shareLink = $('#shareLink');
const shareCopy = $('#shareCopy');
const shareCreate = $('#shareCreate');

// Search modal refs
const btnSearch = $('#btnSearch');
const searchModal = $('#searchModal');
const searchInput = $('#searchInput');
const searchResults = $('#searchResults');

/* =========================
   State & Storage
========================= */
let chats = JSON.parse(localStorage.getItem('jarvisChats') || '[]'); // [{id,title,updated,archived?,messages:[{role,text,ts}]}]
let currentChatId = chats[0]?.id ?? null;

function save(){ localStorage.setItem('jarvisChats', JSON.stringify(chats)); }
function nowISO(){ return new Date().toISOString(); }
function formatTS(tsISO){
  const d = new Date(tsISO), n = new Date();
  const time = d.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' });
  const y = new Date(); y.setDate(n.getDate()-1);
  if(d.toDateString() === n.toDateString()) return time;
  if(d.toDateString() === y.toDateString()) return `Yesterday â€¢ ${time}`;
  return `${d.toLocaleDateString([], {month:'short', day:'numeric'})} â€¢ ${time}`;
}
function ensureChat(titleSeed='New Chat'){
  if(currentChatId) return;
  currentChatId = Date.now();
  chats.unshift({ id: currentChatId, title: titleSeed, updated: nowISO(), messages: [] });
  save(); renderHistory();
}
function setTitleFromFirstMessage(chat){
  const firstUser = chat.messages.find(m => m.role==='user');
  if(firstUser){
    chat.title = firstUser.text.length>28 ? firstUser.text.slice(0,28)+'â€¦' : firstUser.text;
  }
}
function getCurrent(){ return chats.find(c=>c.id===currentChatId); }
function scrollBottom(){ chatBox.scrollTop = chatBox.scrollHeight; }

/* =========================
   Sidebar render
========================= */
function renderHistory(){
  historyEl.innerHTML = '';
  chats.filter(c => !c.archived).forEach((c, i)=>{
    const row = document.createElement('div');
    row.className = 'chat-item';

    // left (title + stamp)
    const left = document.createElement('div');
    left.style.display='flex'; left.style.flexDirection='column'; left.style.gap='2px'; left.style.flex='1';
    const title = document.createElement('div'); title.className='chat-title'; title.textContent=c.title;
    const stamp = document.createElement('div'); stamp.className='chat-stamp'; stamp.textContent=formatTS(c.updated);
    left.append(title, stamp);

    // right (3 dots)
    const right = document.createElement('div');
    right.className='chat-right';
    const dots = document.createElement('div');
    dots.className='dot-btn';
    dots.innerHTML = '<i class="fa-solid fa-ellipsis-vertical"></i>';

    // popup menu
    const menu = document.createElement('div');
    menu.className='menu';
    menu.innerHTML = `
      <div class="menu-btn" data-act="rename"><i class="fa-regular fa-pen-to-square"></i>Rename</div>
      <div class="menu-btn" data-act="archive"><i class="fa-regular fa-box-archive"></i>Archive</div>
      <div class="menu-btn" data-act="share"><i class="fa-solid fa-share-nodes"></i>Share</div>
      <div class="menu-btn" data-act="delete"><i class="fa-regular fa-trash-can"></i>Delete</div>
    `;

    dots.onclick = (e)=>{ e.stopPropagation(); document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open')); menu.classList.toggle('open'); };
    document.addEventListener('click', ()=> menu.classList.remove('open'));

    menu.querySelectorAll('.menu-btn').forEach(btn=>{
      btn.onclick = (ev)=>{
        ev.stopPropagation();
        const act = btn.getAttribute('data-act');
        if(act==='rename') renameChat(c.id);
        if(act==='archive') archiveChat(c.id);
        if(act==='delete') deleteChat(c.id);
        if(act==='share') shareChat(c.id);
        menu.classList.remove('open');
      };
    });

    right.appendChild(dots);
    row.append(left, right, menu);

    row.onclick = ()=>{ currentChatId=c.id; renderChat(); if(window.innerWidth<=768) sidebar.classList.remove('open'); };
    historyEl.appendChild(row);
  });
}

/* =========================
   Chat render
========================= */
function renderChat(){
  chatBox.innerHTML='';
  const chat = getCurrent();
  if(!chat){ return; }
  chat.messages.forEach((m, idx)=>{
    const b=document.createElement('div');
    b.className='bubble ' + (m.role==='user'?'user':'bot');
    b.dataset.idx = idx;
    b.innerHTML = `<div>${m.text}</div><span class="meta">${formatTS(m.ts)}</span>`;
    chatBox.appendChild(b);
  });
  scrollBottom();
}
function addMessage(role, text){
  const chat = getCurrent(); if(!chat) return;
  chat.messages.push({ role, text, ts: nowISO() });
  if(role==='user' && chat.messages.length===1) setTitleFromFirstMessage(chat);
  chat.updated = nowISO();
  save(); renderHistory(); renderChat();
}

/* =========================
   Typing indicator
========================= */
let typingEl=null;
function showTyping(){ if(typingEl) return; typingEl=document.createElement('div'); typingEl.className='typing'; typingEl.innerHTML='<div class="dots"><span></span><span></span><span></span></div>'; chatBox.appendChild(typingEl); scrollBottom(); }
function hideTyping(){ if(typingEl){ typingEl.remove(); typingEl=null; }}

/* =========================
   Command detection
========================= */
function detectCommand(text){
  const t = text.toLowerCase().trim();

  // website: "open youtube.com" or "open youtube"
  const openSite = /^open\s+((https?:\/\/)?[a-z0-9.-]+\.[a-z]{2,})(\/\S*)?$/i;
  if(openSite.test(t)) return { mode:'command', raw: t };

  // open app
  if(/^(open|launch)\s+(app\s+)?[a-z0-9 ._-]+$/i.test(t)) return { mode:'command', raw: t };

  // open file
  if(/^open\s+(the\s+)?file\s+.+/.test(t)) return { mode:'command', raw: t };

  // shutdown / restart
  if(t.includes('shutdown') && !t.includes('cancel')) return { mode:'command', raw: t };
  if(t.includes('restart') || t.includes('reboot')) return { mode:'command', raw: t };

  // ask time quick-answer (let LLM handle too, but we can answer fast)
  if(/^what(?:'s| is)?\s+the\s+time/.test(t)) return { mode:'local', reply: new Date().toLocaleTimeString() };

  return { mode:'chat' };
}

/* =========================
   Backends
========================= */
async function sendToChatLLM(text){
  showTyping();
  try{
    const res = await fetch(CHAT_API, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message: text })
    });

    const data = await res.json();
    console.log("Proxy response:", data); // ðŸ‘ˆ add this for debugging
    hideTyping();

    const reply = data.reply || 'â€¦';
    addMessage('bot', reply);

    if('speechSynthesis' in window) {
      speechSynthesis.speak(new SpeechSynthesisUtterance(reply));
    }
  }catch(err){
    console.error("Frontend error:", err);
    hideTyping();
    addMessage('bot', 'Sorry, AI backend error.');
  }
}
async function sendCommand(raw){
  showTyping();
  try{
    const res = await fetch(CMD_API, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text: raw })
    });
    const data = await res.json();
    hideTyping();
    const msg = data.speech || data.message || 'Command sent.';
    addMessage('bot', msg);
    if(data.speech && 'speechSynthesis' in window) speechSynthesis.speak(new SpeechSynthesisUtterance(data.speech));
  }catch(err){
    console.error(err);
    hideTyping();
    addMessage('bot', 'Command failed (backend unreachable).');
  }
}

/* =========================
   Share popup
========================= */
function shareChat(id){
  const chat = chats.find(c=>c.id===id); if(!chat) return;

  // If you implement a /share endpoint, generate real URL with chat.id.
  const possible = SHARE_BASE + id; // placeholder URL

  shareLink.value = possible;
  shareModal.style.display='block';

  shareCreate.onclick = async ()=>{
    // If you have an API to persist shared chats, call it here and set shareLink.value to returned URL.
    // Fallback: copy chat text to clipboard.
    const text = chat.messages.map(m => `${m.role}: ${m.text}`).join('\n');
    try{
      await navigator.clipboard.writeText(text);
      alert('Chat copied to clipboard (no share API configured).');
    }catch(_){ alert('Copy failed.'); }
  };
}
shareClose.onclick = ()=> shareModal.style.display='none';
shareCopy.onclick = async ()=>{
  try{ await navigator.clipboard.writeText(shareLink.value); alert('Link copied!'); }catch(_){ alert('Copy failed.'); }
};
window.addEventListener('click', e=>{ if(e.target===shareModal) shareModal.style.display='none'; });

/* =========================
   Menu actions
========================= */
function renameChat(id){
  const chat = chats.find(c=>c.id===id); if(!chat) return;
  const nn = prompt('Enter new name:', chat.title);
  if(nn){ chat.title = nn; chat.updated=nowISO(); save(); renderHistory(); }
}
function archiveChat(id){
  const chat = chats.find(c=>c.id===id); if(!chat) return;
  chat.archived = true; save(); renderHistory();
  if(currentChatId===id){ currentChatId = chats.find(c=>!c.archived)?.id ?? null; renderChat(); }
}
function deleteChat(id){
  if(!confirm('Delete this chat?')) return;
  const idx = chats.findIndex(c=>c.id===id);
  if(idx>-1) chats.splice(idx,1);
  if(currentChatId===id) currentChatId = chats[0]?.id ?? null;
  save(); renderHistory(); renderChat();
}

/* =========================
   Send flow (text + voice)
========================= */
function handleUserText(text){
  if(!text.trim()) return;
  if(!currentChatId){ ensureChat(text); }
  addMessage('user', text);

  const det = detectCommand(text);
  if(det.mode==='local'){
    addMessage('bot', det.reply);
    if('speechSynthesis' in window) speechSynthesis.speak(new SpeechSynthesisUtterance(det.reply));
    return;
  }
  if(det.mode==='command'){ sendCommand(det.raw); }
  else { sendToChatLLM(text); }
}
async function generateImage(prompt) {
  const res = await fetch("/generate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });
  const data = await res.json();
  console.log("Replicate output:", data);
}

sendBtn.onclick = ()=> handleUserText(input.value.trim());
input.addEventListener('keydown', e=>{ if(e.key==='Enter') handleUserText(input.value.trim()); });

/* =========================
   Voice recognition
========================= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if(SpeechRecognition){
  const recog = new SpeechRecognition();
  recog.lang='en-US'; recog.interimResults=false;

  micBtn.onclick = ()=> recog.start();
  recog.onstart = ()=> micBtn.classList.add('listening');
  recog.onend   = ()=> micBtn.classList.remove('listening');
  recog.onresult = e => {
    const transcript = e.results[0][0].transcript.trim();
    handleUserText(transcript);
  };
}else{
  micBtn.style.display='none';
}

/* =========================
   SEARCH: open with button or Ctrl/Cmd + K, query chats & messages
========================= */
function openSearch(){
  searchModal.style.display='block';
  searchModal.setAttribute('aria-hidden','false');
  searchInput.value='';
  renderSearchResults('');
  setTimeout(()=> searchInput.focus(), 0);
}
function closeSearch(){
  searchModal.style.display='none';
  searchModal.setAttribute('aria-hidden','true');
}

btnSearch.onclick = openSearch;

// Keyboard shortcut
window.addEventListener('keydown', (e)=>{
  const meta = e.ctrlKey || e.metaKey;
  if(meta && e.key.toLowerCase()==='k'){
    e.preventDefault();
    openSearch();
  }
  if(e.key==='Escape' && searchModal.style.display==='block') closeSearch();
});

// Close when clicking backdrop
searchModal.addEventListener('click', (e)=>{ if(e.target===searchModal) closeSearch(); });

// Debounced search
let sTimer=null;
searchInput.addEventListener('input', ()=>{
  clearTimeout(sTimer);
  sTimer = setTimeout(()=> renderSearchResults(searchInput.value.trim()), 150);
});

function normalize(str){ return str.toLowerCase(); }
function resultRow({id, title, snippet, updated}){
  const el = document.createElement('div');
  el.className='result';
  el.innerHTML = `
    <div class="r-left">
      <div class="r-title">${title}</div>
      <div class="r-snippet">${snippet || ''}</div>
    </div>
    <div class="r-time">${formatTS(updated)}</div>
  `;
  el.onclick = ()=>{
    currentChatId = id;
    renderChat();
    renderHistory();
    closeSearch();
    if(window.innerWidth<=768) sidebar.classList.remove('open');
  };
  return el;
}

function renderSearchResults(q){
  searchResults.innerHTML='';
  const list = [];
  const needle = normalize(q);
  const pool = chats.filter(c=>!c.archived);

  if(!needle){
    // show recent chats when no query
    pool.sort((a,b)=> new Date(b.updated)-new Date(a.updated))
        .slice(0,10)
        .forEach(c=> list.push({ id:c.id, title:c.title, snippet:c.messages.at(-1)?.text || '', updated:c.updated }));
  } else {
    pool.forEach(c=>{
      const inTitle = normalize(c.title).includes(needle);
      let hit = null;
      if(inTitle){
        hit = c.messages.at(-1)?.text || '';
      } else {
        const m = c.messages.find(m=> normalize(m.text).includes(needle));
        if(m) hit = m.text;
      }
      if(hit!==null){ list.push({ id:c.id, title:c.title, snippet:hit, updated:c.updated }); }
    });
  }

  if(list.length===0){
    const empty = document.createElement('div');
    empty.className='result';
    empty.innerHTML = '<div class="r-left"><div class="r-title">No results</div><div class="r-snippet">Try different keywords.</div></div>';
    searchResults.appendChild(empty);
    return;
  }

  list.forEach(item=> searchResults.appendChild(resultRow(item)));
}

/* =========================
   Top actions + mobile
========================= */
$('#btnNew').onclick = ()=>{ currentChatId=null; ensureChat('New Chat'); renderChat(); };
$('#btnLibrary').onclick = ()=> alert('Library coming soon.');

toggleBtn.onclick = (e)=>{ e.stopPropagation(); sidebar.classList.toggle('open'); };
document.addEventListener('click', (e)=>{ if(window.innerWidth<=768 && !sidebar.contains(e.target) && !toggleBtn.contains(e.target)){ sidebar.classList.remove('open'); }});

/* =========================
   Boot
========================= */
if(chats.length===0){ ensureChat('New Chat'); }
renderHistory(); renderChat();
</script>
</body>
</html>